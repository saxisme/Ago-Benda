/**
 * Custom jQuery for Custom Metaboxes and Fields
 *//*jslint browser: true, devel: true, indent: 4, maxerr: 50, sub: true *//*global jQuery, tb_show, tb_remove */"use strict";var CMB={_initCallbacks:[],_clonedFieldCallbacks:[],_deletedFieldCallbacks:[],init:function(){var e=this;jQuery(document).ready(function(){jQuery(".field.repeatable").each(function(){e.isMaxFields(jQuery(this))});jQuery(document).on("click",".delete-field",function(t){t.preventDefault();e.deleteField(jQuery(this).closest(".field-item"))});jQuery(document).on("click",".repeat-field",function(t){t.preventDefault();e.repeatField(jQuery(this).closest(".field"))});e.doneInit()})},repeatField:function(e){var t,n,r,e,i,s;t=this;if(t.isMaxFields(e,1))return;n=e.children(".field-item.hidden");r=n.clone();r.removeClass("hidden");r.find('input[type!="button"]').not("[readonly]").val("");r.find(".cmb_upload_status").html("");r.insertBefore(n);i=0;s=["id","name","for","data-id","data-name"];e.children(".field-item").not(n).each(function(){var t=e.hasClass("CMB_Group_Field")?/cmb-group-(\d|x)*/g:/cmb-field-(\d|x)*/g,n=e.hasClass("CMB_Group_Field")?"cmb-group-"+i:"cmb-field-"+i;jQuery(this).find("["+s.join("],[")+"]").each(function(){for(var e=0;e<s.length;e++)typeof jQuery(this).attr(s[e])!="undefined"&&jQuery(this).attr(s[e],jQuery(this).attr(s[e]).replace(t,n))});i+=1});t.clonedField(r)},deleteField:function(e){var t=e.closest(".field");this.isMaxFields(t,-1);this.deletedField(e);e.remove()},isMaxFields:function(e,t){var n,r,i,s,n;t=t?parseInt(t,10):0;r=e.children(".repeat-field");n=e.children(".field-item").not(".hidden").length+t;s=e.attr("data-rep-max");e.find("> .field-item > .cmb_element > .ui-state-default > .delete-field").show();e.find("> .field-item > .group > .cmb_element > .ui-state-default > .delete-field").show();if(typeof s=="undefined")return!1;n>=parseInt(s,10)?r.attr("disabled","disabled"):r.removeAttr("disabled");if(n>parseInt(s,10))return!0},addCallbackForInit:function(e){this._initCallbacks.push(e)},doneInit:function(){var e=this,t=e._initCallbacks;if(t)for(var n=0;n<t.length;n++)t[n]()},addCallbackForClonedField:function(e,t){if(jQuery.isArray(e))for(var n=0;n<e.length;n++)CMB.addCallbackForClonedField(e[n],t);this._clonedFieldCallbacks[e]=this._clonedFieldCallbacks[e]?this._clonedFieldCallbacks[e]:[];this._clonedFieldCallbacks[e].push(t)},clonedField:function(e){var t=this;e.add(e.find("div[data-class]")).each(function(e,n){n=jQuery(n);var r=t._clonedFieldCallbacks[n.attr("data-class")];if(r)for(var i=0;i<r.length;i++)r[i](n)})},addCallbackForDeletedField:function(e,t){if(jQuery.isArray(e))for(var n=0;n<e.length;n++)CMB._deletedFieldCallbacks(e[n],t);this._deletedFieldCallbacks[e]=this._deletedFieldCallbacks[e]?this._deletedFieldCallbacks[e]:[];this._deletedFieldCallbacks[e].push(t)},deletedField:function(e){var t=this;e.add(e.find("div[data-class]")).each(function(e,n){n=jQuery(n);var r=t._deletedFieldCallbacks[n.attr("data-class")];if(r)for(var i=0;i<r.length;i++)r[i](n)})}};jQuery(document).ready(function(){CMB.init()});CMB.addCallbackForDeletedField("CMB_wysiwyg",function(e){e.find(".cmb-wysiwyg textarea").each(function(){var e=tinyMCE.get(jQuery(this).attr("id"));typeof e!="undefined"&&e.remove()})});CMB.addCallbackForClonedField("CMB_wysiwyg",function(e){e.find(".cmb-wysiwyg").each(function(e){var t,n,r,i,s,e,o,u,a;t=jQuery(this);n=t.attr("data-id");r=t.attr("data-name");i=tinyMCE.get(n);o=t.attr("data-field-id");if(i)return;u=new RegExp("cmb-placeholder-name-"+o,"g");a=new RegExp("cmb-placeholder-id-"+o,"g");t.html(cmb_wysiwyg_editors[o].replace(u,r).replace(a,n));if(typeof tinyMCEPreInit.mceInit[n]=="undefined"){var f=jQuery.extend({},tinyMCEPreInit.mceInit["cmb-placeholder-id-"+o]);for(var l in f)"string"==typeof f[l]&&(f[l]=f[l].replace(a,n).replace(u,r));tinyMCEPreInit.mceInit[n]=f}if(typeof tinyMCEPreInit.qtInit[n]=="undefined"){var c=jQuery.extend({},tinyMCEPreInit.qtInit["cmb-placeholder-id-"+o]);for(var l in c)"string"==typeof c[l]&&(c[l]=c[l].replace(a,n).replace(u,r));tinyMCEPreInit.qtInit[n]=c}var h=t.find(".wp-editor-wrap").hasClass("tmce-active")?"tmce":"html";if("tmce"===h){var i=new tinymce.Editor(n,tinyMCEPreInit.mceInit[n]);i.render()}QTags.instances[0]=undefined;try{quicktags(tinyMCEPreInit.qtInit[n])}catch(p){}})});CMB.addCallbackForInit(function(){jQuery("input:text.cmb_colorpicker").wpColorPicker()});CMB.addCallbackForClonedField("CMB_Color_Picker",function(e){e.find(".wp-color-result").remove();e.find("input:text.cmb_colorpicker").wpColorPicker()});CMB.addCallbackForClonedField(["CMB_Date_Field","CMB_Time_Field","CMB_Date_Timestamp_Field","CMB_Datetime_Timestamp_Field"],function(e){e.find(".cmb_datepicker").each(function(){jQuery(this).attr("id","").removeClass("hasDatepicker").removeData("datepicker").unbind().datepicker()});e.find(".cmb_timepicker").each(function(){jQuery(this).timePicker({startTime:"00:00",endTime:"23:30",show24Hours:!1,separator:":",step:30})})});CMB.addCallbackForInit(function(){jQuery(".cmb_datepicker").each(function(){jQuery(this).datepicker()});jQuery("#ui-datepicker-div").wrap('<div class="cmb_element" />');jQuery(".cmb_timepicker").each(function(){jQuery(this).timePicker({startTime:"00:00",endTime:"23:30",show24Hours:!1,separator:":",step:30})})});var cmbSelectInit=function(){jQuery(".cmb_select").each(function(){var e=jQuery(this),t=e.attr("data-field-id");if(t&&t in window.cmb_select_fields&&e.is(":visible")&&!e.hasClass("select2-added")){options=window.cmb_select_fields[t];e.addClass("select2-added").select2(options)}})};CMB.addCallbackForInit(cmbSelectInit);CMB.addCallbackForClonedField("CMB_Select",cmbSelectInit);CMB.addCallbackForClonedField("CMB_Post_Select",cmbSelectInit);CMB.addCallbackForClonedField("CMB_Taxonomy_Select",cmbSelectInit);(function(e){function t(e){e.setFullYear(2001),e.setMonth(0),e.setDate(0);return e}function n(e,n){if(e){var r=e.split(n.separator),i=parseFloat(r[0]),s=parseFloat(r[1]);n.show24Hours||(i===12&&e.indexOf("AM")!==-1?i=0:i!==12&&e.indexOf("PM")!==-1&&(i+=12));var o=new Date(0,0,0,i,s,0);return t(o)}return null}function r(e,r){return typeof e=="object"?t(e):n(e,r)}function i(e){return(e<10?"0":"")+e}function s(e,t){var n=e.getHours(),r=t.show24Hours?n:(n+11)%12+1,s=e.getMinutes();return i(r)+t.separator+i(s)+(t.show24Hours?"":n<12?" AM":" PM")}function o(t,n,r,i){t.value=e(n).text(),e(t).change(),e.browser.msie||t.focus(),r.hide()}e.fn.timePicker=function(t){var n=e.extend({},e.fn.timePicker.defaults,t);return this.each(function(){e.timePicker(this,n)})},e.timePicker=function(t,n){var r=e(t)[0];return r.timePicker||(r.timePicker=new jQuery._timePicker(r,n))},e.timePicker.version="0.3",e._timePicker=function(i,u){var l=!1,h=!1,p=r(u.startTime,u),d=r(u.endTime,u),v="selected",m="li."+v;e(i).attr("autocomplete","OFF");var y=[],w=new Date(p);while(w<=d)y[y.length]=s(w,u),w=new Date(w.setMinutes(w.getMinutes()+u.step));var E=e('<div class="time-picker'+(u.show24Hours?"":" time-picker-12hours")+'"></div>'),S=e("<ul></ul>");for(var x=0;x<y.length;x++)S.append("<li>"+y[x]+"</li>");E.append(S),E.appendTo("body").hide(),E.mouseover(function(){l=!0}).mouseout(function(){l=!1}),e("li",S).mouseover(function(){h||(e(m,E).removeClass(v),e(this).addClass(v))}).mousedown(function(){l=!0}).click(function(){o(i,this,E,u),l=!1});var T=function(){if(E.is(":visible"))return!1;e("li",E).removeClass(v);var r=e(i).offset();E.css({top:r.top+i.offsetHeight,left:r.left}),E.show();var o=i.value?n(i.value,u):p,l=p.getHours()*60+p.getMinutes(),h=o.getHours()*60+o.getMinutes()-l,m=Math.round(h/u.step),y=t(new Date(0,0,0,0,m*u.step+l,0));y=p<y&&y<=d?y:p;var b=e("li:contains("+s(y,u)+")",E);b.length&&(b.addClass(v),E[0].scrollTop=b[0].offsetTop);return!0};e(i).focus(T).click(T),e(i).blur(function(){l||E.hide()});var N=e.browser.opera||e.browser.mozilla?"keypress":"keydown";e(i)[N](function(t){var n;h=!0;var r=E[0].scrollTop;switch(t.keyCode){case 38:if(T())return!1;n=e(m,S);var s=n.prev().addClass(v)[0];s?(n.removeClass(v),s.offsetTop<r&&(E[0].scrollTop=r-s.offsetHeight)):(n.removeClass(v),s=e("li:last",S).addClass(v)[0],E[0].scrollTop=s.offsetTop-s.offsetHeight);return!1;case 40:if(T())return!1;n=e(m,S);var f=n.next().addClass(v)[0];f?(n.removeClass(v),f.offsetTop+f.offsetHeight>r+E[0].offsetHeight&&(E[0].scrollTop=r+f.offsetHeight)):(n.removeClass(v),f=e("li:first",S).addClass(v)[0],E[0].scrollTop=0);return!1;case 13:if(E.is(":visible")){var l=e(m,S)[0];o(i,l,E,u)}return!1;case 27:E.hide();return!1}return!0}),e(i).keyup(function(e){h=!1}),this.getTime=function(){return n(i.value,u)},this.setTime=function(t){i.value=s(r(t,u),u),e(i).change()}},e.fn.timePicker.defaults={step:30,startTime:new Date(0,0,0,0,0,0),endTime:new Date(0,0,0,23,30,0),separator:":",show24Hours:!0}})(jQuery);var tf_image_uploaders={},ImageWellController=new function(){var e=this;e.addFileUploadCallbackForImageWell=function(t,n){if(!tf_image_uploaders[t]){setTimeout(function(){e.addFileUploadCallbackForImageWell(t,n)},1e3);return}tf_image_uploaders[t].bind("FileUploaded",function(){setTimeout(function(){n()},100)})}};jQuery(document).ready(function(e){var t=null,n=null;e(".delete-image").bind("click",function(e){e.preventDefault();var t=jQuery(this).closest(".hm-uploader");t.removeClass("with-image");t.find(".current-image").fadeOut("fast",function(){t.removeClass("with-image")});t.find(".upload-form").show();t.find(".field-val").val("")});var r=e("input:hidden.rwmb-image-prefix").length;e("input:hidden.rwmb-image-prefix").each(function(){prefix=e(this).val();var i=jQuery(this),s=e.extend({container:prefix+"-container",browse_button:prefix+"-browse-button",drop_element:prefix+"-dragdrop"},tf_well_plupload_defaults);s.multipart_params.field_id=prefix;s.multipart_params.size=i.parent().find(".upload-form").attr("data-size");r==1&&(s.filters[0].extensions=i.parent().find(".upload-form").attr("data-extensions"));tf_image_uploaders[prefix]=new plupload.Uploader(e.extend(!0,{},s));tf_image_uploaders[prefix].init();tf_image_uploaders[prefix].bind("FilesAdded",function(e,r){t=104857600,n=parseInt(e.settings.max_file_size,10);plupload.each(r,function(e){i.closest(".hm-uploader").find(".loading-block").fadeIn("fast",function(){i.closest(".hm-uploader").addClass("loading")})});e.refresh();e.start()});tf_image_uploaders[prefix].bind("FileUploaded",function(t,n,r){response_xml=e.parseXML(r.response);res=wpAjax.parseAjaxResponse(response_xml,"ajax-response");if(!1===res.errors){res=res.responses[0];img_id=res.data;img_src=res.supplemental.thumbnail;img_edit=res.supplemental.edit_link;e(i).closest(".hm-uploader").find(".loading-block").fadeOut("fast");e(i).closest(".hm-uploader").find(".current-image img").attr("src",img_src).removeAttr("width").removeAttr("height");e(i).closest(".hm-uploader").find(".current-image").show();setTimeout(function(){e(i).closest(".hm-uploader").find(".current-image").fadeIn("fast",function(){e(i).closest(".hm-uploader").removeClass("loading");e(i).closest(".hm-uploader").addClass("with-image")})},100);e(i).closest(".hm-uploader").find(".field-val").val(img_id)}})})});jQuery(document).ready(function(){jQuery(document).on("click",".cmb-file-upload",function(t){t.preventDefault();var n=jQuery(this).parent(),r=jQuery(this),i=wp.media({state:"cmb-file",states:[new e]});i.on("toolbar:create:cmb-file",function(e){this.createSelectToolbar(e,{text:"Select file"})},i);i.open();i.state("cmb-file").on("select",function(){var e=i.state().get("selection"),t=e.first(),s=n.find(".cmb-file-holder");jQuery(n).find(".cmb-file-upload-input").val(t.id);r.hide();i.close();var o=t.attributes.type==="image"?"type-img":"type-file";s.addClass(o);s.html("");s.parent().show();jQuery("<img />",{src:t.attributes.type==="image"?t.attributes.sizes.thumbnail.url:t.attributes.icon}).prependTo(n.find(".cmb-file-holder"));t.attributes.type!=="image"&&s.append(jQuery('<div class="cmb-file-name" />').html("<strong>"+t.attributes.filename+"</strong>"))})});jQuery(document).on("click",".cmb-remove-file",function(e){e.preventDefault();var t=jQuery(this).parent().parent();t.find(".cmb-file-holder").html("").parent().hide();t.find(".cmb-file-upload-input").val("");t.find(".cmb-file-upload").show()});var e=wp.media.controller.Library.extend({defaults:_.defaults({id:"cmb-file",filterable:"uploaded",multiple:!1,toolbar:"cmb-file",title:"Select File",priority:60,syncSelection:!1},wp.media.controller.Library.prototype.defaults),initialize:function(){var e,t;wp.media.controller.Library.prototype.initialize.apply(this,arguments);e=this.get("library");t=e.comparator},activate:function(){this.updateSelection();this.frame.on("open",this.updateSelection,this);wp.media.controller.Library.prototype.activate.apply(this,arguments)},deactivate:function(){this.frame.off("open",this.updateSelection,this);wp.media.controller.Library.prototype.deactivate.apply(this,arguments)},updateSelection:function(){var e=this.get("selection"),t=wp.media.view.settings.post.featuredImageId,n;if(""!==t&&-1!==t){n=wp.media.model.Attachment.get(t);n.fetch()}e.reset(n?[n]:[])}})});